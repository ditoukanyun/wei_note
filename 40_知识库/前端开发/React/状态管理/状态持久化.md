---
title: "状态持久化"
date: 2026-02-11
tags: [前端架构, 用户体验, 概念]
category: 前端开发
status: active
---

# 状态持久化 (State Persistence)

## 定义

状态持久化是指将应用状态**保存到非易失性存储**（如 localStorage、IndexedDB），在应用重新加载时恢复的技术。

## 为什么需要

- **用户体验**：刷新页面不丢失数据
- **离线支持**：在无网络时保持可用
- **跨会话**：用户偏好设置长期保存
- **性能优化**：减少不必要的 API 调用

## 存储选项对比

| 存储 | 容量 | 生命周期 | 适用场景 |
|-----|------|---------|---------|
| **localStorage** | ~5MB | 永久 | 用户偏好、主题设置 |
| **sessionStorage** | ~5MB | 标签页关闭 | 临时表单数据 |
| **IndexedDB** | 较大 | 永久 | 离线应用、大量数据 |
| **Cookie** | ~4KB | 可配置 | 身份验证令牌 |

## Zustand persist 中间件

```typescript
import { persist, createJSONStorage } from 'zustand/middleware'

const useStore = create(
  persist(
    (set) => ({
      theme: 'light',
      setTheme: (theme) => set({ theme }),
    }),
    {
      name: 'app-storage',
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({ theme: state.theme }),
    }
  )
)
```

## 最佳实践

### 1. 选择性持久化

```typescript
// ✅ 只持久化必要数据
partialize: (state) => ({
  settings: state.settings,
  preferences: state.preferences,
})

// ❌ 不要持久化敏感数据
partialize: (state) => ({
  token: state.token,  // 安全风险
  user: state.user,    // 可能过期
})
```

### 2. 数据迁移

```typescript
{
  name: 'my-storage',
  version: 2,
  migrate: (persistedState, version) => {
    if (version === 1) {
      // 从 v1 迁移到 v2
      return {
        ...persistedState,
        newField: persistedState.oldField,
      }
    }
    return persistedState
  },
}
```

### 3. 处理 Hydration

```typescript
const useStore = create(persist(...))

function App() {
  const [hasHydrated, setHasHydrated] = useState(false)
  
  useEffect(() => {
    useStore.persist.onFinishHydration(() => {
      setHasHydrated(true)
    })
  }, [])
  
  if (!hasHydrated) return <Loading />
  return <MainApp />
}
```

## 注意事项

- **存储限制**：localStorage 有 5MB 限制
- **同步阻塞**：localStorage 读写是同步的，大数据量可能影响性能
- **序列化成本**：复杂对象序列化/反序列化有开销
- **隐私合规**：敏感数据不应持久化到客户端

## 相关概念

- [[Zustand]]
- [[选择器模式]]
- [[中间件模式]]
- [[localStorage]]
- [[SSR Hydration]]
- [[离线优先]]
